---
title: "Factors Influencing Abortion Rates in the US"
author: "Linh, Maggie, Nancy, Rachel"
date: "December 5, 2020"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    code_folding: hide
---

```{r include = FALSE}
library(tidyverse)
library(leaflet)
library(sf)
library(rgdal)
library(huxtable)
library(patchwork)
library(broom)
library(plotly)
library(devtools)
library(modelr)
library(mgcv)

knitr::opts_chunk$set(
	fig.width = 6, 
  fig.asp = .6,
  out.width = "90%"
)
theme_set(theme_minimal() + theme(legend.position = "bottom"))
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

# Motivation
For this project, we aim to examine state-level sociodemographic factors that may influence abortion rate. State family planning policies vary widely, with some states more hostile to women attempting to access an abortion, and others more supportive (Nash 2019). One study showed that of women who received a nonhospital abortion, 24% traveled at least 50 miles from their home to an abortion facility (Henshaw 1995). We plan to investigate the relationship between hostility towards abortion, within-county abortion provider access, and abortion rate.  We are interested in visualizing these data to hopefully help disseminate this information in a digestible way to inform outreach/education strategies and policy.

# Related Work
We are additionally interested in the relationship between teen birth rate, public expenditures for contraception, and hostility. 

# Research Questions
* Is there a relationship between hostility towards abortion and access to abortion?
* Is there a relationship between hostility towards abortion and abortion rates by state?
* Is there a relationship between abortion access and abortion rates by state?
* Is there a relationship between abortion access and hostility towards abortion with abortion rates by state?

# Data Sources

The data are pulled from the Guttmacher Institute, which is a research organization founded in 1968 working to study, educate, and advance sexual and reproductive health and rights. The Guttmacher Institute Data Center provides public-access birth, abortion, and contraceptive use demographic data at the national and state levels, and contraceptive use data only at the county level. Since we are interested in multiple study outcomes—abortion rates, contraceptive funding/access, and teen birth rates—we pulled these data at the finest resolution possible, aggregated at the state level, for all 50 US States.

# Exploratory Analysis

## Descriptive Graphs

```{r include = FALSE}
merge_data = read_csv("data/merge_data.csv")
```

### Scatterplot comparing abortion rates and public expenditure on contraceptives 

Existing literature suggests state funding for abortions and family planning produced public health benefits, namely reducing unwanted pregnancies and thus lower abortion rate as well as better mother and infant health. We want to generate a plot to look at the relationship between public expenditure on family planning services including contraception for women in need and the rate of abortion. We divide the total reported public expenditures for family planning services by the number of women in reproductive age in each state to get the expenditure rate for each state, which may not be accurately reflective of each's state demographic as well as the cost of abortion. 

```{r, warning = FALSE, message = FALSE}
expenditure_rate = 
  merge_data %>% 
  mutate(hostility = fct_relevel(hostility, c("hostile", "leans_hostile", "middle_ground", "leans_supportive", "supportive"))) %>% 
  mutate(text_label = str_c("State: ", state_id, "\nHostility: ", hostility)) %>% 
  ggplot(aes(x = expenditure_rate, y = abortion_rate_15_44_state, color = hostility)) + 
  geom_point(size = 3) + theme_bw(base_size = 20) +
  geom_smooth(method = "lm", se = FALSE, color = "red") 

ggplotly(expenditure_rate, text = ~str_c("State: ", state_id)) %>% 
    layout(
    yaxis = list(title = "Abortion rate (per 1,000 women aged 15-44)", titlefont = list(size = .2)),
    xaxis = list(title = "Public expenditure rate (per number of women in need)", titlefont = list(size = .2))
  )
```

### Rate of abortion by state

```{r, fig.height = 6, fig.width = 12, fig.asp = .6}
merge_data %>% 
  mutate(state_id = fct_reorder(state_id, abortion_rate_15_44_state)) %>% 
  ggplot(aes(x = state_id, y = abortion_rate_15_44_state, fill = state_id)) +
  geom_bar(stat = "identity") +
  labs(
    x = "State",
    y = "Abortion rate",
    title = "Rate of abortion per 1000 women aged 15-44 by state of residence"
  ) +
  theme(legend.position = "none")
```

### Public expenditure by state

```{r, fig.height = 6, fig.width = 12, fig.asp = .6}
merge_data %>% 
  mutate(state_id = fct_reorder(state_id, expenditure_rate)) %>% 
  ggplot(aes(x = state_id, y = expenditure_rate, fill = state_id)) +
  geom_bar(stat = "identity") +
  labs(
    x = "State",
    y = "Public expenditure per women in need",
    title = "Rate of public expenditure for women aged 15-44 in need of contraception"
  ) +
  theme(legend.position = "none")
  
```

### Abortion Rate and Public Expenditure

We hypothesized that the more a state spends on family planning services including providing contraception for women in need, the lower the abortion rate is in that state. 

```{r, fig.height = 12, fig.width = 12, fig.asp = .6}
abortion_rate = 
  merge_data %>% 
  ggplot(aes(x = state_id, y = abortion_rate_15_44_state, color = state_id)) +
  geom_bar(stat = "identity") +
  labs(
    x = "State",
    y = "Abortion rate",
    title = "Rate of abortion per 1000 women aged 15-44 by state of residence"
  ) +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1)) 
 

public_expenditure =
  merge_data %>% 
  ggplot(aes(x = state_id, y = expenditure_rate, color = state_id)) +
  geom_bar(stat = "identity") +
  labs(
    x = "State",
    y = "Public expenditure per women in need",
    title = "Rate of public expenditure for women aged 15-44 in need of contraception"
  ) +
  theme(legend.position = "none", axis.text.x = element_text(angle = 45, hjust = 1))

abortion_rate / public_expenditure
```

### Hostility towards abortion in policy by state and abortion rate

One variable we thought would have a relationship to abortion rate was each state's abortion policy demonstrates hostility to or support of abortion rights. Each state is placed in one of five categories according to the Guttmacher Institute, including hostile, leans hostile, middle ground, leans supportive and supportive. We believe that the more supportive a state is towards abortion rights, the higher the abortion rate in that state. 

```{r, fig.height = 9, fig.width = 9, fig.asp = .6}
merge_data %>% 
  select(state_id, percent_abortion, abortion_rate_15_44_state ,hostility) %>% 
  mutate(hostility = as.factor(hostility)) %>% 
  group_by(hostility) %>% 
  summarize(
    n = n(),
    abortion_rate = mean(abortion_rate_15_44_state)
  ) %>% 
  mutate(hostility = fct_relevel(hostility, c("hostile", "leans_hostile", "middle_ground", "leans_supportive", "supportive"))) %>% 
  ggplot(aes(x = hostility, y = abortion_rate, fill = hostility)) +
  geom_bar(stat = "identity") + 
  labs(
    x = "Hostility towards abortion in policy by state",
    y = "Average rate of abortion by state",
    title = "Hostility and Abortion Rate"
  )
```

## Spatial Visualizations

To create the maps of our relevant variables, we first read in a US state shapefile downloaded from the [US Census Bureau](https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html). We then read in our tidied Guttmacher dataset, and did some additional tidying.

```{r}
# import US state shapefile from data folder
all_states <- readOGR("data/cb_2018_us_state_500k/cb_2018_us_state_500k.shp")

# read in project data
merge_data = read_csv("data/merge_data.csv") %>% 
  rename(STUSPS = state_id) %>% # to match shapefile column name 
  mutate_if(is.numeric, round, digits = 2) %>%  # round to 2 decimal places
  mutate(hostility = as.factor(hostility)) %>%
  mutate(hostility = fct_relevel(hostility, c("hostile", "leans_hostile", "middle_ground", "leans_supportive", "supportive"))) %>% # for mapping hostility as a categorical variable
  mutate(hostility = recode(hostility,
                            hostile = "Hostile",
                            leans_hostile = "Leans Hostile",
                            middle_ground = "Middle Ground",
                            leans_supportive = "Leans Supportive",
                            supportive = "Supportive")) # cleaner hostility names for map

```

We then joined the Guttmacher data to the shapefile.

```{r}
data_sf <- merge(all_states, merge_data, all.x = F) 
```

We then created a universal basemap and for each map, we created a continuous-scale color palette.

### Abortion Rates

```{r}
# make color palette
abortion_rate_pal <- colorNumeric(
  palette = "inferno",
  domain = data_sf$percent_abortion,
  reverse = TRUE)

# base map
base_map <- leaflet(data_sf) %>%
  addProviderTiles("CartoDB.PositronNoLabels") 

# add in custom labels for percent abortion
labels_abortion_rate <- sprintf(
  "<strong>%s</strong><br/>%g&#37;",
  data_sf$STUSPS, data_sf$percent_abortion
) %>% lapply(htmltools::HTML)

# full map
abortion_map = base_map %>% 
  addPolygons(
  fillColor = ~abortion_rate_pal(data_sf$percent_abortion),
  weight = 2,
  opacity = 1,
  color = "white",
  dashArray = "3",
  fillOpacity = 0.7,
  highlight = highlightOptions(
    weight = 5,
    color = "#666",
    dashArray = "",
    fillOpacity = 0.7,
    bringToFront = TRUE),
  label = labels_abortion_rate,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto")) %>% 
  addLegend(pal = abortion_rate_pal, values = ~percent_abortion, opacity = 0.7, title = 'Abortion Rates by State <br> (% of pregnancies ending in abortions)',
  position = "bottomright")
abortion_map
```

### Public Contraceptive Expenditure Rates

```{r}
# make color palette
bc_fund_pal <- colorNumeric(
  palette = "inferno",
  domain = data_sf$expenditure_rate,
  reverse = TRUE)

# add in custom labels for public contraceptive expenditure
labels_bc_fund <- sprintf(
  "<strong>%s</strong><br/>&#36;%g/woman",
  data_sf$STUSPS, data_sf$expenditure_rate
) %>% lapply(htmltools::HTML)

# full map
bc_fund_map = base_map %>% 
  addPolygons(
  fillColor = ~bc_fund_pal(data_sf$expenditure_rate),
  weight = 2,
  opacity = 1,
  color = "white",
  dashArray = "3",
  fillOpacity = 0.7,
  highlight = highlightOptions(
    weight = 5,
    color = "#666",
    dashArray = "",
    fillOpacity = 0.7,
    bringToFront = TRUE),
  label = labels_bc_fund,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto")) %>% 
  addLegend(pal = bc_fund_pal, values = ~expenditure_rate, opacity = 0.7, title = 'Public Contraceptive Expenditure Rate by State  <br> ($/woman in likely need of publicly-funded services)',
  position = "bottomright")

bc_fund_map
```

### Percent of Women Without Access to Abortion Provider in County of Residence

```{r}
# make color palette
abortion_access_pal <- colorNumeric(
  palette = "inferno",
  domain = data_sf$percent_women_no_provider,
  reverse = TRUE)

# add in custom labels for public contraceptive expenditure
labels_abortion_access <- sprintf(
  "<strong>%s</strong><br/>%g&#37;",
  data_sf$STUSPS, data_sf$percent_women_no_provider
) %>% lapply(htmltools::HTML)

# full map
abortion_access_map = base_map %>% 
  addPolygons(
  fillColor = ~abortion_access_pal(data_sf$percent_women_no_provider),
  weight = 2,
  opacity = 1,
  color = "white",
  dashArray = "3",
  fillOpacity = 0.7,
  highlight = highlightOptions(
    weight = 5,
    color = "#666",
    dashArray = "",
    fillOpacity = 0.7,
    bringToFront = TRUE),
  label = labels_abortion_access,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto")) %>% 
  addLegend(pal = abortion_access_pal, values = ~percent_women_no_provider, opacity = 0.7, title = 'Percent of women living in a county <br> without access to abortion clinic by State',
  position = "bottomright")

abortion_access_map
```

### Teen Birth Rates

```{r}
# make color palette
teen_births_pal <- colorNumeric(
  palette = "inferno",
  domain = data_sf$birthrate_15_19_state,
  reverse = TRUE)

# add in custom labels for public contraceptive expenditure
labels_teen_births <- sprintf(
  "<strong>%s</strong><br/> %g births per 1000 women",
  data_sf$STUSPS, data_sf$birthrate_15_19_state
) %>% lapply(htmltools::HTML)


# full map
teen_births_map = base_map %>% 
  addPolygons(
  fillColor = ~teen_births_pal(data_sf$birthrate_15_19_state),
  weight = 2,
  opacity = 1,
  color = "white",
  dashArray = "3",
  fillOpacity = 0.7,
  highlight = highlightOptions(
    weight = 5,
    color = "#666",
    dashArray = "",
    fillOpacity = 0.7,
    bringToFront = TRUE),
  label = labels_teen_births,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto")) %>% 
  addLegend(pal = teen_births_pal, values = ~birthrate_15_19_state, opacity = 0.7, title = 'No. of births per 1000 women aged 15-19',
  position = "bottomright")

teen_births_map
```

### Hostility toward Abortion Rights by State in 2010

```{r}
# make color palette
hostility_pal <- colorFactor(
  palette = "inferno",
  domain = data_sf$hostility,
  reverse = F)

# add in custom labels for public contraceptive expenditure
labels_hostility <- sprintf(
  "<strong>%s</strong><br/>%s",
  data_sf$STUSPS, data_sf$hostility
) %>% lapply(htmltools::HTML)

# full map
hostility_map = base_map %>% 
  addPolygons(
  fillColor = ~hostility_pal(data_sf$hostility),
  weight = 2,
  opacity = 1,
  color = "white",
  dashArray = "3",
  fillOpacity = 0.7,
  highlight = highlightOptions(
    weight = 5,
    color = "#666",
    dashArray = "",
    fillOpacity = 0.7,
    bringToFront = TRUE),
  label = labels_hostility,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto")) %>% 
  addLegend(pal = hostility_pal, 
            values = ~hostility, 
            opacity = 1, 
            title = 'Hostility Rating towards Abortion Rights in 2010',
  position = "bottomright")

hostility_map
```

## ShinyApp for Maps

We also rendered an additional interactive shinyapp for the maps, viewable [here](https://rachelhtao.shinyapps.io/maps/).

# Regression Models

We ran a few different linear regression analyses to round out our exploratory data analysis. The tables below summarizes the effect estimates we found for these models:

#### Table 1. Simple linear regression: Is there a relationship between hostility towards abortion and access to abortion?

```{r}
# linear model
hostility_bc_access <- lm(percent_women_no_provider ~ hostility, data = merge_data) 

# table to visualize results
hostility_bc_access_tbl = hux(
  Outcome = c("Outcome", 
              "% Women Living in County w/o Provider", "", "", "", ""), 
  Predictors = c("Predictor", 
                 "Hostile (Intercept)", 
                 "Leans Hostile", 
                 "Middle Ground", 
                 "Leans Supportive", 
                 "Supportive"), 
  Estimate = c("Estimate", 
               hostility_bc_access$coefficients[1], 
               hostility_bc_access$coefficients[2],
               hostility_bc_access$coefficients[3],
               hostility_bc_access$coefficients[4],
               hostility_bc_access$coefficients[5]), 
  P_value = c("P-value", 
              summary(hostility_bc_access)$coefficients[,"Pr(>|t|)"][1], 
              summary(hostility_bc_access)$coefficients[,"Pr(>|t|)"][2],
              summary(hostility_bc_access)$coefficients[,"Pr(>|t|)"][3],
              summary(hostility_bc_access)$coefficients[,"Pr(>|t|)"][4],
              summary(hostility_bc_access)$coefficients[,"Pr(>|t|)"][5]),
  add_colnames = FALSE
)
hostility_bc_access_tbl %>% 
  set_bold(1, everywhere, TRUE) %>% 
  set_bottom_border(1, everywhere, 2) %>% 
  set_align(everywhere, 2, 'right') %>% 
  set_right_padding(10) %>% 
  set_left_padding(10) %>% 
  set_width(0.35) %>% 
  set_number_format(3)

```


#### Table 2. Simple linear regression: Is there a relationship between hostility towards abortion and abortion rates by state?

```{r}
# linear model
hostility_model = lm(abortion_rate_15_44_state ~ hostility, data = merge_data) 

# table to visualize results
hostility_abortion_tbl = hux(
  Outcome = c("Outcome", 
              "Abortion Rate", "", "", "", ""), 
  Predictors = c("Predictor", 
                 "Hostile (Intercept)", 
                 "Leans Hostile", 
                 "Middle Ground", 
                 "Leans Supportive", 
                 "Supportive"), 
  Estimate = c("Estimate", 
               hostility_model$coefficients[1], 
               hostility_model$coefficients[2],
               hostility_model$coefficients[3],
               hostility_model$coefficients[4],
               hostility_model$coefficients[5]), 
  P_value = c("P-value", 
              summary(hostility_model)$coefficients[,"Pr(>|t|)"][1], 
              summary(hostility_model)$coefficients[,"Pr(>|t|)"][2],
              summary(hostility_model)$coefficients[,"Pr(>|t|)"][3],
              summary(hostility_model)$coefficients[,"Pr(>|t|)"][4],
              summary(hostility_model)$coefficients[,"Pr(>|t|)"][5]),
  add_colnames = FALSE
)
hostility_abortion_tbl %>% 
  set_bold(1, everywhere, TRUE) %>% 
  set_bottom_border(1, everywhere, 2) %>% 
  set_align(everywhere, 2, 'right') %>% 
  set_right_padding(10) %>% 
  set_left_padding(10) %>% 
  set_width(0.35) %>% 
  set_number_format(3)

```

#### Table 3. Simple linear regression: Is there a relationship between abortion access and abortion rates by state?

```{r}
# linear model
bc_access_model <- lm(abortion_rate_15_44_state ~ percent_women_no_provider, data = merge_data) 


# table to visualize results
bc_access_abortion_tbl = hux(
  Outcome = c("Outcome", 
              "Abortion Rate"), 
  Predictors = c("Predictor", 
                 "% Women Living in County w/o Provider"), 
  Estimate = c("Estimate", 
               bc_access_model$coefficients[2]), 
  P_value = c("P-value", 
              summary(bc_access_model)$coefficients[,"Pr(>|t|)"][2]),
  add_colnames = FALSE
)
bc_access_abortion_tbl %>% 
  set_bold(1, everywhere, TRUE) %>% 
  set_bottom_border(1, everywhere, 2) %>% 
  set_align(everywhere, 2, 'right') %>% 
  set_right_padding(10) %>% 
  set_left_padding(10) %>% 
  set_width(0.35) %>% 
  set_number_format(3)

```

#### Table 4. Multivariate regression: Is there a relationship between abortion access and hostility towards abortion with abortion rates by state?

```{r}
hostility_adj_model = lm(abortion_rate_15_44_state ~ hostility + percent_women_no_provider, data = merge_data)

# table to visualize results
hostility_bc_abortion_tbl = hux(
  Outcome = c("Outcome", 
              "Abortion Rate", 
              "", 
              "", 
              "", 
              "", 
              ""), 
  Predictors = c("Predictor", 
                 "Hostile (Intercept)", 
                 "Leans Hostile", 
                 "Middle Ground", 
                 "Leans Supportive", 
                 "Supportive",
                 "% Women Living in County w/o Provider"), 
  Estimate = c("Estimate", 
               hostility_adj_model$coefficients[1], 
               hostility_adj_model$coefficients[2],
               hostility_adj_model$coefficients[3],
               hostility_adj_model$coefficients[4],
               hostility_adj_model$coefficients[5],
               hostility_adj_model$coefficients[6]), 
  P_value = c("P-value", 
              summary(hostility_adj_model)$coefficients[,"Pr(>|t|)"][1], 
              summary(hostility_adj_model)$coefficients[,"Pr(>|t|)"][2],
              summary(hostility_adj_model)$coefficients[,"Pr(>|t|)"][3],
              summary(hostility_adj_model)$coefficients[,"Pr(>|t|)"][4],
              summary(hostility_adj_model)$coefficients[,"Pr(>|t|)"][5],
              summary(hostility_adj_model)$coefficients[,"Pr(>|t|)"][6]),
  add_colnames = FALSE
)
hostility_bc_abortion_tbl %>% 
  set_bold(1, everywhere, TRUE) %>% 
  set_bottom_border(1, everywhere, 2) %>% 
  set_align(everywhere, 2, 'right') %>% 
  set_right_padding(10) %>% 
  set_left_padding(10) %>% 
  set_width(0.35) %>% 
  set_number_format(3)
```


# Discussion and Conclusion

-LINH AND MAGGIE Descriptive statistic interpretations (Graphs + Maps)  
-MAGGIE Regression model interpretations  
-RACHEL Why we didn't include models with teen birth rate (tying into study limitations of this analysis being underpowered)  

-NANCY Future research: finer resolution spatial data or individual-level data